import pandas as pd
import subprocess
import threading
import queue

data = pd.read_csv('malware_data_families/worm.csv')
hash_strings = data["sha256"].tolist()

hash_strings = hash_strings[:2600]

from os import listdir

ofiles = [f for f in listdir("E:\\SpywareDataset\\sophos\\worm")]


remaining = set(hash_strings) - set(ofiles)

Queue = queue.Queue()

for i in remaining:
    Queue.put(i)


def download():

    while Queue:
        current_hash = Queue.get()
        result = subprocess.Popen(
            args=f'aws s3 cp s3://sorel-20m/09-DEC-2020/binaries/{current_hash} E:\\SpywareDataset\\sophos\\worm --no-sign-request',
            shell=True, stdout=subprocess.PIPE, stdin=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = result.communicate()
        result = stdout + stderr
        print(result.decode(), Queue.qsize())


for i in range(4):
    threading.Thread(target=download).start()
